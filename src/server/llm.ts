import { Ingredient } from "@/lib/types";
import { createOpenAI } from "@ai-sdk/openai";
import { generateObject } from "ai";
import zod from "zod";

export function createGitHubModels() {
  const githubToken = process.env.GITHUB_TOKEN;
  if (!githubToken) {
    throw new Error("GitHub token not configured");
  }

  return createOpenAI({
    apiKey: githubToken,
    baseURL: "https://models.github.ai/inference",
  });
}

export async function generateRecipeTags({ name, ingredients }: { name?: string; ingredients: Ingredient[] }) {
  const githubModels = createGitHubModels();
  const systemPrompt = `You are an expert cocktail sommelier. Generate a list of relevant tags for a cocktail recipe based on its ingredients and name.
  Guidelines:
  - Focus on flavor profiles, ingredients, and cocktail types
  - Keep it concise, 3-5 tags maximum
  - Avoid generic tags like "cocktail" or "drink"
  - Use lowercase, no spaces, separate with commas
  - Do not include the name of the cocktail in the tags`;
  
  const userPrompt = `Generate tags for a cocktail recipe with these ingredients: ${ingredients
    .map((ing) => `${ing.amount} ${ing.unit} ${ing.name}`)
    .join(", ")}${name ? ` and name "${name}"` : ""}`;

  const result = await generateObject({
    model: githubModels(process.env.CHAT_MODEL || "openai/gpt-4.1-nano"),
    system: systemPrompt,
    prompt: userPrompt,
    schema: zod.object({
      tags: zod.array(zod.string().min(1)),
    }),
  });
  
  if (!result && !result.object) {
    console.warn("No tags generated by LLM");
  }
  return result.object.tags;
}